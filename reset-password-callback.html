<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting to Recipe AI...</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: #f5f5f5;
        }
        .debug {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 600px;
            text-align: left;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h2>Redirecting to Recipe AI app...</h2>
    <div id="debug" class="debug" style="display: none;">
        <strong>Debug Info:</strong><br>
        <div id="debug-content"></div>
    </div>
    <script>
        // Get full URL for debugging
        const fullUrl = window.location.href;
        const hash = window.location.hash.substring(1); // Remove #
        const searchParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(hash);
        
        // Extract tokens from both hash fragment and query parameters
        let accessToken = hashParams.get('access_token') || searchParams.get('access_token');
        let refreshToken = hashParams.get('refresh_token') || searchParams.get('refresh_token');
        let type = hashParams.get('type') || searchParams.get('type');
        let token = hashParams.get('token') || searchParams.get('token');
        
        // Debug info
        const debugInfo = {
            'Full URL': fullUrl,
            'Hash': hash || '(empty)',
            'Query String': window.location.search || '(empty)',
            'Type': type || '(not found)',
            'Access Token': accessToken ? 'Found (' + accessToken.substring(0, 20) + '...)' : 'Not found',
            'Refresh Token': refreshToken ? 'Found (' + refreshToken.substring(0, 20) + '...)' : 'Not found',
            'Token (alt)': token ? 'Found (' + token.substring(0, 20) + '...)' : 'Not found'
        };
        
        // Show debug info (remove in production)
        const debugDiv = document.getElementById('debug');
        const debugContent = document.getElementById('debug-content');
        debugDiv.style.display = 'block';
        debugContent.innerHTML = Object.entries(debugInfo).map(([key, value]) => 
            `<strong>${key}:</strong> ${value}<br>`
        ).join('');
        
        // Try to get access token (priority: access_token > token)
        const finalAccessToken = accessToken || token;
        
        // Redirect if we have tokens
        if (finalAccessToken) {
            // Build app URL with tokens
            let appUrl = 'com.recipeai.app://reset-password';
            
            if (finalAccessToken && refreshToken) {
                // Use hash fragment format (PKCE flow)
                appUrl += `#access_token=${encodeURIComponent(finalAccessToken)}&refresh_token=${encodeURIComponent(refreshToken)}`;
            } else if (finalAccessToken) {
                // Fallback: just access_token
                appUrl += `#access_token=${encodeURIComponent(finalAccessToken)}`;
            }
            
            // Log for debugging
            console.log('Redirecting to:', appUrl);
            
            // Redirect to app
            window.location.href = appUrl;
            
            // Fallback: Show message if app doesn't open
            setTimeout(() => {
                document.body.innerHTML = `
                    <h2>If the app did not open automatically:</h2>
                    <p>1. Make sure Recipe AI app is installed</p>
                    <p>2. Open Recipe AI manually</p>
                    <p>3. Request a new password reset email</p>
                    <hr>
                    <details>
                        <summary>Debug Info (click to expand)</summary>
                        <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
                    </details>
                `;
            }, 2000);
        } else {
            // No tokens found
            document.body.innerHTML = `
                <h2>Invalid reset link</h2>
                <p>Please request a new password reset email.</p>
                <hr>
                <details>
                    <summary>Debug Info (click to expand)</summary>
                    <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
                    <p><strong>Note:</strong> If you're testing by accessing this URL directly, you need tokens in the URL from Supabase's email.</p>
                </details>
            `;
        }
    </script>
</body>
</html>
